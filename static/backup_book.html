<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
    <title>Neo4j Books</title>
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: #f8f9fa;
        margin: 0;
        padding: 0;
      }

      #book-list {
        max-height: 200px;
        overflow-y: auto;
        padding: 10px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      #graph {
        height: 400px;
        background-color: #ffffff;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      .navbar {
        margin-bottom: 20px;
        position: sticky;
        top: 0;
        z-index: 100;
        background-color: #ffffff;
      }

      .panel {
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .panel-heading {
        font-weight: bold;
        background-color: #007bff;
        color: #ffffff;
        padding: 10px;
        border-bottom: 1px solid #ddd;
      }

      #add-book-form {
        padding: 20px;
        background-color: #fff;
        border-radius: 5px;
      }

      .node.author { fill: #4caf50; }
      .node.book { fill: #ff5722; }
      .link { stroke: #bbb; stroke-opacity: 0.6; }
      .text { font-size: 12px; fill: #333; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container">
        <a class="navbar-brand" href="#">Book Management System</a>
        <form class="d-flex" id="search">
          <input class="form-control me-2" type="search" placeholder="Search for Book Title" name="search" />
          <button class="btn btn-primary" type="submit">Search</button>
        </form>
      </div>
    </nav>

    <div class="container">
      <!-- Add Book Form -->
      <div class="panel">
        <div class="panel-heading">Add New Book</div>
        <form id="add-book-form">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="title" class="form-label">Title*</label>
              <input type="text" class="form-control" id="title" name="title" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="genre" class="form-label">Genre</label>
              <input type="text" class="form-control" id="genre" name="genre">
            </div>
          </div>
          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="summary" class="form-label">Summary</label>
              <textarea class="form-control" id="summary" name="summary" rows="3"></textarea>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="released" class="form-label">Release Date</label>
              <input type="date" class="form-control" id="released" name="released">
            </div>
            <div class="col-md-4 mb-3">
              <label for="rated" class="form-label">Rating</label>
              <input type="text" class="form-control" id="rated" name="rated">
            </div>
            <div class="col-md-4 mb-3">
              <label for="tagline" class="form-label">Tagline</label>
              <input type="text" class="form-control" id="tagline" name="tagline">
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Add Book</button>
        </form>
      </div>

      <div class="row">
        <!-- Graph View -->
        <div class="col-md-7 mb-3">
          <div class="panel">
            <div class="panel-heading">Book-Author Network</div>
            <div id="graph"></div>
          </div>
        </div>
        <!-- Search Results -->
        <div class="col-md-5 mb-3">
          <div class="panel">
            <div class="panel-heading">Search Results</div>
            <div id="book-list">
              <ul id="results" class="list-group"></ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Book Details -->
      <div class="panel">
        <div class="panel-heading">Book Details</div>
        <div class="row p-3">
          <div class="col-md-8">
            <h4 id="book-title"></h4>
            <p id="book-summary"></p>
            <div id="book-info">
              <p><strong>Genre:</strong> <span id="book-genre"></span></p>
              <p><strong>Released:</strong> <span id="book-released"></span></p>
              <p><strong>Rating:</strong> <span id="book-rated"></span></p>
            </div>
            <h5>Authors</h5>
            <ul id="authors" class="list-group"></ul>
            <button id="vote" class="btn btn-primary mt-3">Vote for this book</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript">
      $(function () {
        // Show book details
        function showBook(title) {
          $.get("/book/" + encodeURIComponent(title), function (data) {
            if (!data) return;
            $("#book-title").text(data.title);
            const $list = $("#authors").empty();
            data.authors.forEach(function (author) {
              $list.append(
                $(`<li class="list-group-item">${author.name} - ${author.job}${
                  author.role ? ` (${author.role})` : ''
                }</li>`)
              );
            });
            $("#vote").off("click").on("click", function () {
              voteInBook(data.title);
            });
          });
          return false;
        }

        // Search functionality
        function search() {
          const query = $("#search input[name=search]").val();
          $.get("/search?q=" + encodeURIComponent(query), function (data) {
            const t = $("#results").empty();
            if (!data || data.length === 0) {
              t.append('<li class="list-group-item">No results found</li>');
              return;
            }
            data.forEach(function (book) {
              $(`<li class="list-group-item">
                  <h5>${book.title}</h5>
                  <p class="mb-1">${book.summary || 'No summary available'}</p>
                  <small>Genre: ${book.genre || 'N/A'}</small>
                </li>`)
                .appendTo(t)
                .click(function () {
                  showBook(book.title);
                });
            });
          });
          return false;
        }

        // Vote functionality
        function voteInBook(title) {
          $.post(`/book/${encodeURIComponent(title)}/vote`, function(response) {
            alert('Vote recorded!');
          });
        }

        // Add book functionality
        $("#add-book-form").submit(function(e) {
          e.preventDefault();
          const formData = {
            title: $("#title").val(),
            summary: $("#summary").val(),
            released: $("#released").val(),
            genre: $("#genre").val(),
            rated: $("#rated").val(),
            tagline: $("#tagline").val()
          };

          $.ajax({
            url: '/book',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
              alert('Book added successfully!');
              $("#add-book-form")[0].reset();
              search();
            },
            error: function(xhr) {
              alert('Error adding book: ' + xhr.responseJSON.error);
            }
          });
        });

        // Graph visualization
        const width = 800, height = 800;
        const force = d3.layout.force()
          .charge(-200)
          .linkDistance(30)
          .size([width, height]);

        const svg = d3.select("#graph")
          .append("svg")
          .attr("width", "100%")
          .attr("height", "100%")
          .attr("pointer-events", "all");

        d3.json("/graph", function (error, graph) {
          if (error) return;
          force.nodes(graph.nodes).links(graph.links).start();
          
          const link = svg.selectAll(".link")
            .data(graph.links)
            .enter()
            .append("line")
            .attr("class", "link");

          const node = svg.selectAll(".node")
            .data(graph.nodes)
            .enter()
            .append("circle")
            .attr("class", d => `node ${d.label}`)
            .attr("r", 10)
            .call(force.drag);

          node.append("title").text(d => d.title);

          // Add text labels for nodes
          svg.selectAll(".text")
            .data(graph.nodes)
            .enter()
            .append("text")
            .attr("class", "text")
            .attr("dx", 12)
            .attr("dy", ".35em")
            .text(d => d.title);

          // Add text labels for links
          svg.selectAll(".link-text")
            .data(graph.links)
            .enter()
            .append("text")
            .attr("class", "text")
            .attr("dx", 12)
            .attr("dy", ".35em")
            .text("WROTE");

          force.on("tick", () => {
            link
              .attr("x1", d => d.source.x)
              .attr("y1", d => d.source.y)
              .attr("x2", d => d.target.x)
              .attr("y2", d => d.target.y);
            node
              .attr("cx", d => d.x)
              .attr("cy", d => d.y);
            svg.selectAll(".text")
              .attr("x", d => d.x)
              .attr("y", d => d.y);
            svg.selectAll(".link-text")
              .attr("x", d => (d.source.x + d.target.x) / 2)
              .attr("y", d => (d.source.y + d.target.y) / 2);
          });
        });

        // Initialize search on page load
        $("#search").submit(search);
        search();
      });
    </script>
  </body>
</html>